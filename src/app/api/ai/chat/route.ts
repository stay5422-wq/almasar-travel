import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    const {
      message,
      context,
      conversationHistory,
      history, // Ø¯Ø¹Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
      prompt, // Ø¯Ø¹Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø­ØªÙˆÙ‰
      locale,
    } = body;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    if (!message && !prompt) {
      return NextResponse.json(
        { error: 'Missing required field: message or prompt' },
        { status: 400 }
      );
    }

    // Check Demo Mode
    if (process.env.DEMO_MODE === 'true') {
      // Ù…Ø­ØªÙˆÙ‰ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø°ÙƒÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹
      const topicLower = (prompt || message).toLowerCase();
      let demoContent = '';
      
      if (topicLower.includes('Ø³ÙØ±') || topicLower.includes('Ø¹Ø·Ù„') || topicLower.includes('Ø³ÙŠØ§Ø­')) {
        demoContent = `ğŸŒ Ø§ÙƒØªØ´Ù Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø³ÙØ± Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ³Ù…!

Ù‡Ù„ ØªØ­Ù„Ù… Ø¨Ø±Ø­Ù„Ø© Ù„Ø§ ØªÙÙ†Ø³Ù‰ Ù…Ø¹ Ø¹Ø§Ø¦Ù„ØªÙƒØŸ Ø¥Ù„ÙŠÙƒ Ø§Ù„ÙØ±ØµØ© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©!

âœ¨ **Ù„Ù…Ø§Ø°Ø§ ØªØ®ØªØ§Ø± Ø¹Ø±ÙˆØ¶Ù†Ø§ØŸ**
â€¢ Ø¨Ø§Ù‚Ø§Øª Ø´Ø§Ù…Ù„Ø© Ø¨Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ© ØªØ¨Ø¯Ø£ Ù…Ù† 2999 Ø±ÙŠØ§Ù„
â€¢ ÙÙ†Ø§Ø¯Ù‚ 5 Ù†Ø¬ÙˆÙ… ÙÙŠ Ø£Ø¬Ù…Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
â€¢ Ø¨Ø±Ø§Ù…Ø¬ Ø³ÙŠØ§Ø­ÙŠØ© Ù…ØªÙ†ÙˆØ¹Ø© ØªÙ†Ø§Ø³Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø°ÙˆØ§Ù‚
â€¢ Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡ Ù…ØªÙ…ÙŠØ²Ø© Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©

ğŸ¯ **Ø¹Ø±Ø¶ Ø®Ø§Øµ Ù„ÙØªØ±Ø© Ù…Ø­Ø¯ÙˆØ¯Ø©:**
Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù† ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø®ØµÙ… 20% + ØªØ£Ù…ÙŠÙ† Ø³ÙØ± Ù…Ø¬Ø§Ù†ÙŠ!

ğŸ“ Ù„Ù„Ø­Ø¬Ø² ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±: ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø§Ù„Ø¢Ù†
ğŸŒŸ Ù„Ø§ ØªÙÙˆØª Ù‡Ø°Ù‡ Ø§Ù„ÙØ±ØµØ© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©!

#Ø³ÙØ± #Ø³ÙŠØ§Ø­Ø© #Ø¹Ø±ÙˆØ¶_Ø³ÙØ± #Ø¹Ø·Ù„Ø§Øª_Ø¹Ø§Ø¦Ù„ÙŠØ©`;
      } else if (topicLower.includes('ØªØ³ÙˆÙŠÙ‚') || topicLower.includes('Ø¥Ø¹Ù„Ø§Ù†')) {
        demoContent = `ğŸš€ ÙƒÙŠÙ ØªØ¶Ø§Ø¹Ù Ù…Ø¨ÙŠØ¹Ø§ØªÙƒ Ø¨Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù…ÙŠØŸ

ÙÙŠ Ø¹ØµØ± Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØŒ 78% Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª ØªØ³ÙˆÙŠÙ‚ Ù…Ø¯Ø±ÙˆØ³Ø©.

ğŸ’¡ **Ø®Ø·ÙˆØ§Øª Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ù†Ø¬Ø§Ø­:**
1. **Ø§ÙÙ‡Ù… Ø¬Ù…Ù‡ÙˆØ±Ùƒ:** Ø­Ø¯Ø¯ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙ‡Ù… ÙˆØªØ·Ù„Ø¹Ø§ØªÙ‡Ù… Ø¨Ø¯Ù‚Ø©
2. **Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ùˆ Ø§Ù„Ù…Ù„Ùƒ:** Ù‚Ø¯Ù… Ù‚ÙŠÙ…Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‚Ø¨Ù„ Ø£Ù† ØªØ¨ÙŠØ¹
3. **Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªÙ…Ø±:** Ø§Ø³ØªÙ…Ø¹ Ù„Ø¹Ù…Ù„Ø§Ø¦Ùƒ ÙˆØªØ¬Ø§ÙˆØ¨ Ù…Ø¹Ù‡Ù… ÙÙˆØ±Ø§Ù‹
4. **Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±:** Ø±Ø§Ù‚Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ­Ø³Ù‘Ù† Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±

ğŸ“Š **Ù†ØªØ§Ø¦Ø¬ Ù…Ø¶Ù…ÙˆÙ†Ø©:**
Ø¹Ù…Ù„Ø§Ø¤Ù†Ø§ Ø­Ù‚Ù‚ÙˆØ§ Ø²ÙŠØ§Ø¯Ø© 150% ÙÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø®Ù„Ø§Ù„ 3 Ø£Ø´Ù‡Ø± ÙÙ‚Ø·!

ğŸ’¬ Ø´Ø§Ø±ÙƒÙ†Ø§: Ù…Ø§ Ø£ÙƒØ¨Ø± ØªØ­Ø¯ÙŠ ØªÙˆØ§Ø¬Ù‡Ù‡ ÙÙŠ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù…ÙŠØŸ

#ØªØ³ÙˆÙŠÙ‚_Ø±Ù‚Ù…ÙŠ #Ù†Ø¬Ø§Ø­ #Ø±ÙŠØ§Ø¯Ø©_Ø£Ø¹Ù…Ø§Ù„`;
      } else if (topicLower.includes('ØµØ­Ø©') || topicLower.includes('Ø±ÙŠØ§Ø¶')) {
        demoContent = `ğŸƒâ€â™‚ï¸ 5 Ø¹Ø§Ø¯Ø§Øª ØµØ­ÙŠØ© ØªØºÙŠØ± Ø­ÙŠØ§ØªÙƒ Ù„Ù„Ø£ÙØ¶Ù„!

Ø§Ù„ØµØ­Ø© Ù‡ÙŠ Ø§Ù„Ø«Ø±ÙˆØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ ÙˆØ¨Ù†Ø§Ø¡ Ù†Ù…Ø· Ø­ÙŠØ§Ø© ØµØ­ÙŠ Ø£Ø³Ù‡Ù„ Ù…Ù…Ø§ ØªØªØ®ÙŠÙ„.

âœ… **Ø¹Ø§Ø¯Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ù†ØªØ§Ø¦Ø¬ ÙƒØ¨ÙŠØ±Ø©:**
1. **Ø§Ø¨Ø¯Ø£ ÙŠÙˆÙ…Ùƒ Ø¨Ø§Ù„Ù…Ø§Ø¡:** ÙƒÙˆØ¨ Ù…Ø§Ø¡ Ø¯Ø§ÙØ¦ Ø¹Ù„Ù‰ Ø§Ù„Ø±ÙŠÙ‚ ÙŠÙ†Ø´Ø· Ø§Ù„Ø¬Ø³Ù…
2. **Ø§Ù„Ù…Ø´ÙŠ 30 Ø¯Ù‚ÙŠÙ‚Ø©:** ÙŠØ­Ø³Ù† Ø§Ù„Ù…Ø²Ø§Ø¬ ÙˆÙŠÙ‚ÙˆÙŠ Ø§Ù„Ù‚Ù„Ø¨
3. **Ø§Ù„Ù†ÙˆÙ… Ø§Ù„ÙƒØ§ÙÙŠ:** 7-8 Ø³Ø§Ø¹Ø§Øª ØªØ¬Ø¯Ø¯ Ø·Ø§Ù‚ØªÙƒ
4. **Ø§Ù„Ø·Ø¹Ø§Ù… Ø§Ù„ØµØ­ÙŠ:** Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ø®Ø¶Ø§Ø± ÙˆØ§Ù„ÙÙˆØ§ÙƒÙ‡ Ø§Ù„Ø·Ø§Ø²Ø¬Ø©
5. **Ø§Ù„Ø§Ø³ØªØ±Ø®Ø§Ø¡:** Ø®ØµØµ 10 Ø¯Ù‚Ø§Ø¦Ù‚ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù„Ù„ØªØ£Ù…Ù„

ğŸŒŸ **Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ** Ø·Ø§Ù‚Ø© Ø£Ø¹Ù„Ù‰ØŒ Ù…Ù†Ø§Ø¹Ø© Ø£Ù‚ÙˆÙ‰ØŒ ÙˆØ­ÙŠØ§Ø© Ø£ÙƒØ«Ø± Ø³Ø¹Ø§Ø¯Ø©!

ğŸ’ª Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ…... Ù„Ø§ ØªØ¤Ø¬Ù„ ØµØ­ØªÙƒ!

#ØµØ­Ø© #Ù„ÙŠØ§Ù‚Ø© #Ù†Ù…Ø·_Ø­ÙŠØ§Ø©_ØµØ­ÙŠ`;
      } else {
        demoContent = `âœ¨ ${prompt.split(':')[1]?.substring(0, 50) || 'Ù…Ø­ØªÙˆÙ‰ Ø§Ø­ØªØ±Ø§ÙÙŠ Ù…Ø®ØµØµ Ù„Ùƒ'}

Ù‡Ù„ ØªØ¨Ø­Ø« Ø¹Ù† Ø­Ù„ÙˆÙ„ Ù…Ø¨ØªÙƒØ±Ø© ØªØ­Ø¯Ø« ÙØ±Ù‚Ø§Ù‹ Ø­Ù‚ÙŠÙ‚ÙŠØ§Ù‹ØŸ Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ù†Ù‚Ø¯Ù… Ù„Ùƒ Ø§Ù„Ø£ÙØ¶Ù„!

ğŸ¯ **Ù„Ù…Ø§Ø°Ø§ Ù†Ø­Ù† Ù…Ø®ØªÙ„ÙÙˆÙ†ØŸ**
â€¢ Ø®Ø¨Ø±Ø© ÙˆØ§Ø³Ø¹Ø© ÙÙŠ Ø§Ù„Ù…Ø¬Ø§Ù„ ØªÙ…ØªØ¯ Ù„Ø³Ù†ÙˆØ§Øª
â€¢ ÙØ±ÙŠÙ‚ Ù…Ø­ØªØ±Ù Ù…Ù„ØªØ²Ù… Ø¨ØªØ­Ù‚ÙŠÙ‚ Ø£Ù‡Ø¯Ø§ÙÙƒ
â€¢ Ø­Ù„ÙˆÙ„ Ù…Ø®ØµØµØ© ØªÙ†Ø§Ø³Ø¨ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø§Ù„ÙØ±ÙŠØ¯Ø©
â€¢ Ù†ØªØ§Ø¦Ø¬ Ù…Ù„Ù…ÙˆØ³Ø© ÙŠÙ…ÙƒÙ†Ùƒ Ù‚ÙŠØ§Ø³Ù‡Ø§

ğŸ’¡ **Ù…Ø§ ÙŠÙ…ÙŠØ² Ø®Ø¯Ù…Ø§ØªÙ†Ø§:**
âœ“ Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© Ù„Ø§ ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ø§ÙˆÙ…Ø©
âœ“ Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ© ØªÙ†Ø§Ø³Ø¨ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ
âœ“ Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…ØªÙˆØ§ØµÙ„ Ù„Ø±Ø§Ø­Ø© Ø¨Ø§Ù„Ùƒ
âœ“ Ø¶Ù…Ø§Ù† Ø§Ù„Ø±Ø¶Ø§ 100%

ğŸ“ **ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø§Ù„Ø¢Ù†** ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¬Ø§Ù†ÙŠØ©!
ğŸŒ Ø¯Ø¹Ù†Ø§ Ù†Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ ØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø°ÙŠ ØªØ³ØªØ­Ù‚Ù‡.

#Ø§Ø­ØªØ±Ø§ÙÙŠØ© #ØªÙ…ÙŠØ² #Ù†Ø¬Ø§Ø­ #Ø¬ÙˆØ¯Ø©`;
      }
      
      return NextResponse.json({
        success: true,
        response: demoContent,
        content: demoContent,
        metadata: {
          timestamp: new Date().toISOString(),
          mode: 'demo',
        },
      });
    }

    // Real OpenAI API call
    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });

    const userMessage = prompt || message;
    const systemMessage = locale === 'ar' 
      ? 'Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©. Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø¬Ø°Ø§Ø¨ ÙˆØ§Ø­ØªØ±Ø§ÙÙŠ.'
      : 'You are an AI assistant specialized in writing marketing content. Write engaging and professional content.';

    const messages: any[] = [
      { role: 'system', content: systemMessage }
    ];

    // Add conversation history if provided
    const historyArray = history || conversationHistory || [];
    if (historyArray.length > 0) {
      messages.push(...historyArray);
    }

    // Add current message
    messages.push({ role: 'user', content: userMessage });

    const response = await openai.chat.completions.create({
      model: process.env.OPENAI_MODEL || 'gpt-4o',
      messages,
      temperature: 0.7,
      max_tokens: 500,
    });

    const content = response.choices[0]?.message?.content || 'ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰';

    return NextResponse.json({
      success: true,
      response: content,
      content: content,
      metadata: {
        timestamp: new Date().toISOString(),
        mode: 'live',
      },
    });

  } catch (error: any) {
    console.error('Chat Error:', error);
    
    return NextResponse.json(
      { 
        error: 'Failed to get AI response',
        message: error.message 
      },
      { status: 500 }
    );
  }
}